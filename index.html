<script>
    async function handleFileUpload() {
        const fileInput = document.getElementById('csvFile');
        const uploadStatus = document.getElementById('upload-status');
        const researchResults = document.getElementById('research-results');
        const emailContent = document.getElementById('email-content');
        
        if (!fileInput.files[0]) {
            alert('Please select a file first!');
            return;
        }

        uploadStatus.innerHTML = '<div class="status">Processing file...</div>';

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function(e) {
            const base64Data = e.target.result.split(',')[1];

            try {
                const response = await fetch('https://fboyzgif8d.execute-api.us-east-1.amazonaws.com/prod/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(base64Data)
                });
                
                const responseData = await response.json();
                console.log('Response data:', responseData);
                
                if (response.ok) {
                    if (responseData.error) {
                        uploadStatus.innerHTML = `<div class="status error">Error: ${responseData.error}</div>`;
                        console.error('Error details:', responseData);
                        return;
                    }

                    uploadStatus.innerHTML = '<div class="status success">File processed successfully!</div>';
                    
                    // Display all results
                    let researchHtml = '';
                    let emailHtml = '';
                    
                    responseData.results.forEach((result, index) => {
                        researchHtml += `
                            <div style="margin-bottom: 30px; border-bottom: 1px solid #ccc; padding-bottom: 20px;">
                                <h2>${result.company_info.name} - ${result.company_info.contact}</h2>
                                <div style="max-height: 600px; overflow-y: auto;">
                                    <h3>Overview</h3>
                                    <p>${result.research.overview}</p>
                                    
                                    <h3>Products & Services</h3>
                                    <p>${result.research.products}</p>
                                    
                                    <h3>Market Position</h3>
                                    <p>${result.research.market_position}</p>
                                    
                                    <h3>Recent News</h3>
                                    <p>${result.research.recent_news}</p>
                                    
                                    <h3>Challenges & Opportunities</h3>
                                    <p>${result.research.challenges_opportunities}</p>
                                </div>
                            </div>
                        `;
                        
                        emailHtml += `
                            <div style="margin-bottom: 30px; border-bottom: 1px solid #ccc; padding-bottom: 20px;">
                                <h2>${result.company_info.name} - ${result.company_info.contact}</h2>
                                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 4px;">
                                    <h3>Subject: ${result.email.subject}</h3>
                                    <pre style="white-space: pre-wrap; font-family: Arial, sans-serif;">${result.email.body}</pre>
                                </div>
                            </div>
                        `;
                    });

                    researchResults.innerHTML = researchHtml;
                    emailContent.innerHTML = emailHtml;
                } else {
                    uploadStatus.innerHTML = `<div class="status error">Error: ${JSON.stringify(responseData)}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                uploadStatus.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
            }
        };

        reader.onerror = function(error) {
            console.error('Error:', error);
            uploadStatus.innerHTML = `<div class="status error">Error reading file: ${error}</div>`;
        };

        reader.readAsDataURL(file);
    }
</script>
