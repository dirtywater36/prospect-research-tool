<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">import boto3</p>
<p class="p1">import csv</p>
<p class="p1">import json</p>
<p class="p1">from io import StringIO</p>
<p class="p1">import urllib.parse</p>
<p class="p1">import time</p>
<p class="p2"><br></p>
<p class="p1">def lambda_handler(event, context):</p>
<p class="p1"><span class="Apple-converted-space">    </span>print("Lambda function started!")</p>
<p class="p1"><span class="Apple-converted-space">    </span>print(f"Received event: {json.dumps(event)}")</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>try:</p>
<p class="p1"><span class="Apple-converted-space">        </span># Get the S3 bucket and file details</p>
<p class="p1"><span class="Apple-converted-space">        </span>bucket = event['Records'][0]['s3']['bucket']['name']</p>
<p class="p1"><span class="Apple-converted-space">        </span>key = urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'])</p>
<p class="p1"><span class="Apple-converted-space">        </span>print(f"Processing file: {key} from bucket: {bucket}")</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span># Initialize S3 and Step Functions clients</p>
<p class="p1"><span class="Apple-converted-space">        </span>s3 = boto3.client('s3')</p>
<p class="p1"><span class="Apple-converted-space">        </span>sfn = boto3.client('stepfunctions')</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span># Get the file from S3</p>
<p class="p1"><span class="Apple-converted-space">        </span>print("Retrieving file from S3...")</p>
<p class="p1"><span class="Apple-converted-space">        </span>response = s3.get_object(Bucket=bucket, Key=key)</p>
<p class="p1"><span class="Apple-converted-space">        </span>file_content = response['Body'].read().decode('utf-8-sig')</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span># Process CSV</p>
<p class="p1"><span class="Apple-converted-space">        </span>csv_reader = csv.DictReader(StringIO(file_content))</p>
<p class="p1"><span class="Apple-converted-space">        </span>print(f"CSV headers: {csv_reader.fieldnames}")</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>execution_count = 0</p>
<p class="p1"><span class="Apple-converted-space">        </span>for row in csv_reader:</p>
<p class="p1"><span class="Apple-converted-space">            </span>print(f"Processing row: {json.dumps(row)}")</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span># Clean row data</p>
<p class="p1"><span class="Apple-converted-space">            </span>cleaned_row = {}</p>
<p class="p1"><span class="Apple-converted-space">            </span>for k, v in row.items():</p>
<p class="p1"><span class="Apple-converted-space">                </span>cleaned_key = k.strip().replace('\ufeff', '')</p>
<p class="p1"><span class="Apple-converted-space">                </span>cleaned_row[cleaned_key] = v.strip() if v else ''</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span># Verify required fields</p>
<p class="p1"><span class="Apple-converted-space">            </span>if 'company_name' not in cleaned_row or 'contact_name' not in cleaned_row:</p>
<p class="p1"><span class="Apple-converted-space">                </span>print(f"Warning: Missing required fields in row: {cleaned_row}")</p>
<p class="p1"><span class="Apple-converted-space">                </span>continue</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span># Prepare Step Functions input</p>
<p class="p1"><span class="Apple-converted-space">            </span>input_data = {</p>
<p class="p1"><span class="Apple-converted-space">                </span>"company_name": cleaned_row['company_name'],</p>
<p class="p1"><span class="Apple-converted-space">                </span>"contact_name": cleaned_row['contact_name']</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>print(f"Starting Step Functions execution with input: {json.dumps(input_data)}")</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>try:</p>
<p class="p1"><span class="Apple-converted-space">                </span>response = sfn.start_execution(</p>
<p class="p1"><span class="Apple-converted-space">                    </span>stateMachineArn='arn:aws:states:us-east-1:500585308701:stateMachine:MyStateMachine9425',</p>
<p class="p1"><span class="Apple-converted-space">                    </span>input=json.dumps(input_data)</p>
<p class="p1"><span class="Apple-converted-space">                </span>)</p>
<p class="p1"><span class="Apple-converted-space">                </span>print(f"Step Functions execution started: {response['executionArn']}")</p>
<p class="p1"><span class="Apple-converted-space">                </span>execution_count += 1</p>
<p class="p1"><span class="Apple-converted-space">                </span>time.sleep(3)<span class="Apple-converted-space">  </span># Increased to 3 seconds between executions</p>
<p class="p1"><span class="Apple-converted-space">            </span>except Exception as sfn_error:</p>
<p class="p1"><span class="Apple-converted-space">                </span>print(f"Error starting Step Functions execution: {str(sfn_error)}")</p>
<p class="p1"><span class="Apple-converted-space">                </span>print(f"Error details: {str(sfn_error)}")</p>
<p class="p1"><span class="Apple-converted-space">                </span>time.sleep(5)<span class="Apple-converted-space">  </span># Increased to 5 seconds if there's an error</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>print(f"Processing complete. Started {execution_count} executions.")</p>
<p class="p1"><span class="Apple-converted-space">        </span>return {</p>
<p class="p1"><span class="Apple-converted-space">            </span>'statusCode': 200,</p>
<p class="p1"><span class="Apple-converted-space">            </span>'body': f'Successfully processed {execution_count} rows'</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>except Exception as e:</p>
<p class="p1"><span class="Apple-converted-space">        </span>print(f"Error in Lambda handler: {str(e)}")</p>
<p class="p1"><span class="Apple-converted-space">        </span>raise e</p>
</body>
</html>
